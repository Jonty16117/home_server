services:
  cloudflaretunnel-gitlab:
    image: cloudflare/cloudflared
    env_file: ./.env
    environment:
      - TUNNEL_TOKEN=${CLOUDFLARE_TUNNEL_TOKEN_GITLAB}
    command: tunnel --no-autoupdate run
    deploy:
      resources:
        limits:
          memory: 100M
        reservations:
          memory: 100M
    restart: unless-stopped

  gitlab-nginx:
    image: nginx:latest
    container_name: gitlab-nginx
    volumes:
      - ./gitlab-nginx-config:/etc/nginx/conf.d
    deploy:
      resources:
        limits:
          memory: 100M
        reservations:
          memory: 100M
    restart: unless-stopped

  gitlab:
    image: gitlab/gitlab-ce
    hostname: 'gitlab.kantiwal.xyz'
    volumes:
      # - ./data/gitlab/config:/etc/gitlab
      - ./data/gitlab/logs:/var/log/gitlab
      - ./data/gitlab/data:/var/opt/gitlab
      - ./gitlab-config/gitlab.rb:/etc/gitlab/gitlab.rb
    deploy:
      resources:
        limits:
          memory: 5000M
        reservations:
          memory: 2500M
    shm_size: '256m'

  gitlab-runner-node:
    image: gitlab/gitlab-runner
    volumes:
      - ./data/gitlab-runner-node/config.toml:/etc/gitlab-runner/config.toml
      - ./ssh:/root/.ssh
      - /var/run/docker.sock:/var/run/docker.sock

  gitlab-runner-php:
    image: gitlab/gitlab-runner
    volumes:
      - ./data/gitlab-runner-php/config.toml:/etc/gitlab-runner/config.toml
      - ./ssh:/root/.ssh
      - /var/run/docker.sock:/var/run/docker.sock


  gitlab-runner-alpine:
    image: gitlab/gitlab-runner
    volumes:
      - ./data/gitlab-runner-alpine/config.toml:/etc/gitlab-runner/config.toml
      - ./ssh:/root/.ssh
      - /var/run/docker.sock:/var/run/docker.sock
